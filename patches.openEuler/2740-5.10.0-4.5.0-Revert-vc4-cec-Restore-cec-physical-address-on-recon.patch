Git-commit: 14ebe74a994ec89ec4aad28c613b9eed7161bb9a
From: Maxime Ripard <maxime@cerno.tech>
Date: Tue, 8 Dec 2020 17:12:19 +0100
Subject: [PATCH] Revert "vc4: cec: Restore cec physical address on reconnect"
Patch-mainline: Queued in openEuler repo, version 5.10.0-4.5.0
References: openEuler-21.03
Git-repo: https://gitee.com/openeuler/kernel.git

raspberrypi inclusion
category: feature
bugzilla: 50432

--------------------------------

This reverts commit 250344082a3957825d425ded325547e72a34fd65.

Signed-off-by: Fang Yafen <yafen@iscas.ac.cn>
Signed-off-by: Zheng Zengkai <zhengzengkai@huawei.com>
Signed-off-by: Kai Liu <kai.liu@suse.com>
---
 drivers/gpu/drm/vc4/vc4_hdmi.c | 25 ++++++++-----------------
 1 file changed, 8 insertions(+), 17 deletions(-)

diff --git a/drivers/gpu/drm/vc4/vc4_hdmi.c b/drivers/gpu/drm/vc4/vc4_hdmi.c
index 93351245c77e..6ba26f929bf7 100644
--- a/drivers/gpu/drm/vc4/vc4_hdmi.c
+++ b/drivers/gpu/drm/vc4/vc4_hdmi.c
@@ -452,29 +452,20 @@ static enum drm_connector_status
 vc4_hdmi_connector_detect(struct drm_connector *connector, bool force)
 {
 	struct vc4_hdmi *vc4_hdmi = connector_to_vc4_hdmi(connector);
-	bool connected = false;
 
 	if (vc4_hdmi->hpd_gpio) {
 		if (gpio_get_value_cansleep(vc4_hdmi->hpd_gpio) ^
 		    vc4_hdmi->hpd_active_low)
-			connected = true;
-	} else if (drm_probe_ddc(vc4_hdmi->ddc))
-		connected = true;
+			return connector_status_connected;
+		cec_phys_addr_invalidate(vc4_hdmi->cec_adap);
+		return connector_status_disconnected;
+	}
+
+	if (drm_probe_ddc(vc4_hdmi->ddc))
+		return connector_status_connected;
+
 	if (HDMI_READ(HDMI_HOTPLUG) & VC4_HDMI_HOTPLUG_CONNECTED)
-		connected = true;
-	if (connected) {
-		if (connector->status != connector_status_connected) {
-			struct edid *edid = drm_get_edid(connector, vc4_hdmi->ddc);
-
-			if (edid) {
-				cec_s_phys_addr_from_edid(vc4_hdmi->cec_adap, edid);
-				vc4_hdmi->encoder.hdmi_monitor = drm_detect_hdmi_monitor(edid);
-				drm_connector_update_edid_property(connector, edid);
-				kfree(edid);
-			}
-		}
 		return connector_status_connected;
-	}
 	cec_phys_addr_invalidate(vc4_hdmi->cec_adap);
 	return connector_status_disconnected;
 }
-- 
2.31.1

